rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // Rooms Collection
    // =========================================
    match /rooms/{roomId} {
      // อนุญาตให้ทุกคนอ่านข้อมูลห้อง
      allow read: if true;

      // อนุญาตให้สร้างห้องใหม่ได้
      allow create: if true;

      // อนุญาตให้อัพเดทได้ทุกคน (สำหรับ join/leave room)
      allow update: if true;

      // อนุญาตให้ลบได้
      allow delete: if true;

      // Players Subcollection (สำหรับผู้เล่นในห้อง)
      match /players/{playerId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // =========================================
    // Players Collection
    // =========================================
    match /players/{playerId} {
      // อนุญาตให้ทุกคนอ่านข้อมูลผู้เล่น
      allow read: if true;

      // อนุญาตให้สร้างผู้เล่นใหม่
      allow create: if request.resource.data.keys().hasAll(['id', 'name', 'isHost', 'isReady', 'isOnline', 'joinedAt'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() >= 2
                    && request.resource.data.name.size() <= 20;

      // อนุญาตให้อัพเดทข้อมูลตัวเอง
      allow update: if true;

      // อนุญาตให้ลบผู้เล่น
      allow delete: if true;
    }

    // =========================================
    // Chat Messages Collection
    // =========================================
    match /chat/{roomId}/messages/{messageId} {
      // อนุญาตให้อ่านข้อความในห้องที่เข้าร่วม
      allow read: if true;

      // อนุญาตให้ส่งข้อความได้
      allow create: if request.resource.data.keys().hasAll(['id', 'playerId', 'playerName', 'message', 'timestamp', 'type'])
                    && request.resource.data.message is string
                    && request.resource.data.message.size() > 0
                    && request.resource.data.message.size() <= 500;

      // ไม่อนุญาตให้แก้ไขหรือลบข้อความ
      allow update, delete: if false;
    }

    // =========================================
    // Game Results Collection
    // =========================================
    match /results/{resultId} {
      // อนุญาตให้ทุกคนอ่านผลเกม
      allow read: if true;

      // อนุญาตให้สร้างผลเกม
      allow create: if request.resource.data.keys().hasAll(['roomId', 'gameType', 'finishedAt']);

      // ไม่อนุญาตให้แก้ไขหรือลบผลเกม
      allow update, delete: if false;
    }

    // =========================================
    // Games Collection
    // =========================================
    match /games/{gameId} {
      allow read: if true;
      allow write: if request.auth != null; // เขียนได้เฉพาะ user ที่ login แล้ว (Admin)
    }

    // =========================================
    // ITO Questions Collection
    // =========================================
    match /ito_questions/{questionId} {
      allow read: if true;
      allow create: if true; // อนุญาตให้ทุกคนสร้างคำถามได้
      allow update, delete: if request.auth != null; // admin เท่านั้น
    }

    // =========================================
    // Feedback Collection (NEW)
    // =========================================
    match /feedback/{feedbackId} {
      allow read: if request.auth != null; // admin เท่านั้น
      allow create: if true; // อนุญาตให้ทุกคนสร้าง feedback ได้
      allow update, delete: if request.auth != null; // admin เท่านั้น
    }

    // =========================================
    // User Ages Collection (NEW)
    // =========================================
    match /user_ages/{ageId} {
      allow read: if request.auth != null; // admin เท่านั้น
      allow create: if true; // อนุญาตให้ทุกคนสร้างข้อมูลอายุได้
      allow update, delete: if false; // ไม่อนุญาตให้แก้ไขหรือลบ
    }

    // =========================================
    // Game Sessions Collection
    // =========================================
    match /game_sessions/{sessionId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;

      // Player Answers Subcollection
      match /player_answers/{playerId} {
        allow read: if true;
        allow write: if true;
      }

      // Votes Subcollection
      match /votes/{playerId} {
        allow read: if true;
        allow write: if true;
      }

      // Ready Status Subcollection (for levelComplete phase)
      match /ready_status/{playerId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // =========================================
    // Test Collection (for testing only)
    // =========================================
    match /test/{document=**} {
      allow read, write: if true;
    }
  }
}
